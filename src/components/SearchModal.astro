---
---

<dialog id="search-modal" class="search-dialog">
  <div class="search-backdrop" data-close-search></div>
  <div class="search-panel">
    <header class="search-header">
      <h2 class="text-h3 font-bold text-text-primary">Search</h2>
      <button
        class="text-xs font-bold tracking-widest uppercase text-text-light hover:text-text-primary transition-colors"
        data-close-search
      >
        ESC
      </button>
    </header>
    <div class="search-input-wrap">
      <input
        type="search"
        id="search-input"
        placeholder="Search posts, projects..."
        autocomplete="off"
        class="search-input"
      />
    </div>
    <div id="search-results" class="search-results"></div>
    <p id="search-hint" class="text-xs text-text-light text-center py-md">
      Type to search across all pages
    </p>
  </div>
</dialog>

<script is:inline>
  (function() {
    var pagefind = null;

    async function initPagefind() {
      if (pagefind) return;
      try {
        pagefind = await import('/pagefind/pagefind.js');
        await pagefind.init();
      } catch (e) {
        pagefind = null;
      }
    }

    var dialog = document.getElementById('search-modal');
    var input = document.getElementById('search-input');
    var results = document.getElementById('search-results');
    var hint = document.getElementById('search-hint');

    // Focus input when dialog opens
    var observer = new MutationObserver(function() {
      if (dialog.open) {
        input.focus();
        initPagefind();
      }
    });
    if (dialog) observer.observe(dialog, { attributes: true, attributeFilter: ['open'] });

    // Close handlers
    if (dialog) {
      dialog.querySelectorAll('[data-close-search]').forEach(function(el) {
        el.addEventListener('click', function() { dialog.close(); });
      });

      dialog.addEventListener('click', function(e) {
        if (e.target === dialog) dialog.close();
      });
    }

    // Search input with debounce
    var debounceTimer;
    if (input) {
      input.addEventListener('input', function() {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(async function() {
          var query = input.value.trim();
          if (query.length < 2) {
            results.innerHTML = '';
            hint.style.display = '';
            return;
          }

          if (!pagefind) {
            results.innerHTML = '<p style="text-align:center;padding:1rem;opacity:0.5;font-size:0.875rem;">Search available after build</p>';
            hint.style.display = 'none';
            return;
          }

          var search = await pagefind.search(query);
          hint.style.display = 'none';

          if (search.results.length === 0) {
            results.innerHTML = '<p style="text-align:center;padding:1rem;opacity:0.5;font-size:0.875rem;">No results found</p>';
            return;
          }

          var items = await Promise.all(
            search.results.slice(0, 8).map(function(r) { return r.data(); })
          );

          results.innerHTML = items.map(function(item) {
            return '<a href="' + item.url + '" class="search-result">' +
              '<h3 style="font-size:0.875rem;font-weight:700;">' + (item.meta && item.meta.title || item.url) + '</h3>' +
              '<p style="font-size:0.75rem;opacity:0.7;margin-top:4px;">' + item.excerpt + '</p>' +
              '</a>';
          }).join('');
        }, 200);
      });
    }
  })();
</script>

<style>
  .search-dialog {
    position: fixed;
    inset: 0;
    z-index: 80;
    width: 100%;
    height: 100%;
    max-width: 100%;
    max-height: 100%;
    border: none;
    padding: 0;
    margin: 0;
    background: transparent;
    opacity: 0;
    transition: opacity 180ms ease;
  }

  .search-dialog[open] {
    opacity: 1;
  }

  .search-dialog::backdrop {
    background: transparent;
  }

  .search-backdrop {
    position: fixed;
    inset: 0;
    backdrop-filter: blur(14px) saturate(1.2);
    background: color-mix(in srgb, var(--color-bg-primary) 85%, transparent);
  }

  .search-panel {
    position: relative;
    max-width: 600px;
    margin: 10vh auto;
    border-radius: 24px;
    border: 1px solid var(--color-border);
    background: var(--color-bg-primary);
    box-shadow: 0 24px 80px color-mix(in srgb, var(--color-bg-primary) 20%, rgba(0, 0, 0, 0.3));
    overflow: hidden;
  }

  .search-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 1.5rem;
    border-bottom: 1px solid var(--color-border);
  }

  .search-input-wrap {
    padding: 0.75rem 1.5rem;
  }

  .search-input {
    width: 100%;
    padding: 0.75rem 0;
    border: none;
    background: transparent;
    color: var(--color-text-primary);
    font-size: 1rem;
    font-family: inherit;
    outline: none;
  }

  .search-input::placeholder {
    color: var(--color-text-light);
  }

  .search-results {
    max-height: 60vh;
    overflow-y: auto;
    padding: 0 1.5rem;
  }

  .search-result {
    display: block;
    padding: 0.75rem 0;
    border-top: 1px solid var(--color-border);
    text-decoration: none;
    transition: opacity 120ms ease;
  }

  .search-result:hover {
    opacity: 0.7;
  }
</style>
